name: MLflow CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      n_estimators:
        description: 'Number of estimators'
        required: false
        default: '100'
        type: string
      max_depth:
        description: 'Maximum depth'
        required: false
        default: '20'
        type: string
      min_samples_split:
        description: 'Minimum samples split'
        required: false
        default: '5'
        type: string
      min_samples_leaf:
        description: 'Minimum samples leaf'
        required: false
        default: '2'
        type: string

env:
  MLFLOW_TRACKING_URI: sqlite:///mlflow.db
  DOCKER_IMAGE_NAME: avocado-ripeness-model
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}

jobs:
  mlflow-training:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.10'
        miniforge-variant: Mambaforge
        
    - name: Install MLflow
      shell: bash -l {0}
      run: |
        conda install -c conda-forge mlflow
        pip install mlflow[extras]
        
    - name: Install Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKER_HUB_USERNAME }}
        password: ${{ env.DOCKER_HUB_PASSWORD }}
        
    - name: Run MLflow Project
      shell: bash -l {0}
      working-directory: ./MLProject
      run: |
        # Set parameters from workflow inputs or use defaults
        N_ESTIMATORS=${{ github.event.inputs.n_estimators || '100' }}
        MAX_DEPTH=${{ github.event.inputs.max_depth || '20' }}
        MIN_SAMPLES_SPLIT=${{ github.event.inputs.min_samples_split || '5' }}
        MIN_SAMPLES_LEAF=${{ github.event.inputs.min_samples_leaf || '2' }}
        
        echo "Running MLflow project with parameters:"
        echo "n_estimators: $N_ESTIMATORS"
        echo "max_depth: $MAX_DEPTH"
        echo "min_samples_split: $MIN_SAMPLES_SPLIT"
        echo "min_samples_leaf: $MIN_SAMPLES_LEAF"
        
        # Run the MLflow project
        mlflow run . \
          -P n_estimators=$N_ESTIMATORS \
          -P max_depth=$MAX_DEPTH \
          -P min_samples_split=$MIN_SAMPLES_SPLIT \
          -P min_samples_leaf=$MIN_SAMPLES_LEAF \
          --env-manager conda
          
    - name: Build Docker Image with MLflow
      shell: bash -l {0}
      working-directory: ./MLProject
      run: |
        # Get the latest run ID
        RUN_ID=$(mlflow runs list --experiment-name "Avocado_Ripeness_Classification" --max-results 1 --order-by "attribute.start_time DESC" --output-format json | jq -r '.[0].run_id')
        echo "Latest run ID: $RUN_ID"
        
        # Build Docker image using mlflow build-docker
        mlflow models build-docker \
          -m "runs:/$RUN_ID/model" \
          -n "$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:latest" \
          --enable-mlserver
          
    - name: Tag and Push Docker Image
      shell: bash -l {0}
      run: |
        # Tag with commit SHA
        docker tag "$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:latest" "$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:${{ github.sha }}"
        
        # Push both tags
        docker push "$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:latest"
        docker push "$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:${{ github.sha }}"
        
        echo "Docker images pushed successfully!"
        echo "Latest: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:latest"
        echo "SHA: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:${{ github.sha }}"
        
    - name: Save Model Artifacts
      shell: bash -l {0}
      working-directory: ./MLProject
      run: |
        # Create artifacts directory
        mkdir -p ../artifacts
        
        # Get the latest run ID and copy artifacts
        RUN_ID=$(mlflow runs list --experiment-name "Avocado_Ripeness_Classification" --max-results 1 --order-by "attribute.start_time DESC" --output-format json | jq -r '.[0].run_id')
        echo "Copying artifacts from run: $RUN_ID"
        
        # Copy MLflow artifacts
        if [ -d "mlruns" ]; then
          cp -r mlruns ../artifacts/
        fi
        
        # Copy any generated plots or additional files
        if [ -f "confusion_matrix.png" ]; then
          cp confusion_matrix.png ../artifacts/
        fi
        
        if [ -f "feature_importance.png" ]; then
          cp feature_importance.png ../artifacts/
        fi
        
        # Create a summary file
        echo "MLflow Run Summary" > ../artifacts/run_summary.txt
        echo "==================" >> ../artifacts/run_summary.txt
        echo "Run ID: $RUN_ID" >> ../artifacts/run_summary.txt
        echo "Timestamp: $(date)" >> ../artifacts/run_summary.txt
        echo "Commit SHA: ${{ github.sha }}" >> ../artifacts/run_summary.txt
        echo "Docker Image: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:${{ github.sha }}" >> ../artifacts/run_summary.txt
        
        # List artifacts
        echo "Generated artifacts:" >> ../artifacts/run_summary.txt
        ls -la ../artifacts/ >> ../artifacts/run_summary.txt
        
    - name: Upload Artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts-${{ github.sha }}
        path: artifacts/
        retention-days: 30
        
    - name: Commit and Push Artifacts (if on main branch)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      shell: bash -l {0}
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Create artifacts branch if it doesn't exist
        git fetch origin
        if git show-ref --verify --quiet refs/remotes/origin/artifacts; then
          git checkout artifacts
          git pull origin artifacts
        else
          git checkout --orphan artifacts
          git rm -rf .
        fi
        
        # Copy artifacts
        cp -r artifacts/* . 2>/dev/null || :
        
        # Add timestamp directory
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        mkdir -p "runs/$TIMESTAMP"
        cp -r artifacts/* "runs/$TIMESTAMP/" 2>/dev/null || :
        
        # Commit and push
        git add .
        git commit -m "Add MLflow artifacts from run ${{ github.sha }}" || echo "No changes to commit"
        git push origin artifacts
        
    - name: Update Docker Hub Link
      shell: bash -l {0}
      run: |
        # Update the docker-hub-link.txt with the new image
        echo "https://hub.docker.com/repository/docker/$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME" > MLProject/docker-hub-link.txt
        echo "Latest image: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:latest" >> MLProject/docker-hub-link.txt
        echo "SHA image: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:${{ github.sha }}" >> MLProject/docker-hub-link.txt
        
    - name: Display Run Summary
      shell: bash -l {0}
      run: |
        echo "ðŸŽ‰ MLflow CI/CD Pipeline Completed Successfully!"
        echo "=============================================="
        echo "âœ… Model training completed"
        echo "âœ… Docker image built and pushed to Docker Hub"
        echo "âœ… Artifacts saved to GitHub repository"
        echo ""
        echo "ðŸ“Š Run Details:"
        echo "Docker Image: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:latest"
        echo "Commit SHA: ${{ github.sha }}"
        echo "Workflow URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ðŸ”— Resources:"
        echo "- Docker Hub: https://hub.docker.com/repository/docker/$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME"
        echo "- Artifacts: Available in GitHub Actions artifacts and 'artifacts' branch"