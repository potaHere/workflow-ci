name: MLflow CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      n_estimators:
        description: 'Number of estimators'
        required: false
        default: '100'
        type: string
      max_depth:
        description: 'Maximum depth'
        required: false
        default: '20'
        type: string
      min_samples_split:
        description: 'Minimum samples split'
        required: false
        default: '5'
        type: string
      min_samples_leaf:
        description: 'Minimum samples leaf'
        required: false
        default: '2'
        type: string

env:
  DOCKER_IMAGE_NAME: avocado-ripeness-model
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}

jobs:
  mlflow-training:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.10'
        miniforge-variant: Miniforge3
        channels: conda-forge,nodefaults
        channel-priority: strict
        
    - name: Install MLflow
      shell: bash -l {0}
      run: |
        python -m pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy matplotlib seaborn
        
    - name: Train Model with MLflow Project
      working-directory: ${{ github.workspace }}/MLProject
      run: |
        # Set the tracking URI for this step
        MLFLOW_DB_PATH="$(pwd)/mlflow.db"
        export MLFLOW_TRACKING_URI="sqlite:///$MLFLOW_DB_PATH"
        
        # Create artifacts directory
        mkdir -p ../artifacts
        
        # Get the latest run ID with better error handling
        RUN_ID=""
        
        # Method 1: Try with mlflow CLI and jq
        if command -v mlflow >/dev/null 2>&1 && command -v jq >/dev/null 2>&1; then
          RUN_ID=$(MLFLOW_TRACKING_URI="$MLFLOW_TRACKING_URI" mlflow runs list --experiment-name "Avocado_Ripeness_Classification" --max-results 1 --order-by "attribute.start_time DESC" --output-format json 2>/dev/null | jq -r '.[0].run_id' 2>/dev/null || echo "")
        fi
        
        # Method 2: Fallback to filesystem search
        if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
          echo "ðŸ”„ Fallback: Searching mlruns directory..."
          RUN_ID=$(find mlruns -name "meta.yaml" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | awk '{print $2}' | sed 's|.*/\([^/]*\)/meta.yaml|\1|' || echo "")
        fi
        
        if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
          echo "âŒ Error: Could not find any MLflow run ID!"
          echo "ðŸ“ MLruns directory contents:"
          find mlruns -type f -name "meta.yaml" 2>/dev/null | head -10
          exit 1
        fi
        
        echo "Copying artifacts from run: $RUN_ID"
        
        # Copy MLflow artifacts
        if [ -d "mlruns" ]; then
          cp -r mlruns ../artifacts/
        fi
        
        # Copy database
        if [ -f "mlflow.db" ]; then
          cp mlflow.db ../artifacts/
        fi
        
        # Copy any generated plots or additional files
        if [ -f "confusion_matrix.png" ]; then
          cp confusion_matrix.png ../artifacts/
        fi
        
        if [ -f "feature_importance.png" ]; then
          cp feature_importance.png ../artifacts/
        fi
        
        # Create a summary file
        echo "MLflow Run Summary" > ../artifacts/run_summary.txt
        echo "==================" >> ../artifacts/run_summary.txt
        echo "Run ID: $RUN_ID" >> ../artifacts/run_summary.txt
        echo "Timestamp: $(date)" >> ../artifacts/run_summary.txt
        echo "Commit SHA: ${{ github.sha }}" >> ../artifacts/run_summary.txt
        echo "Docker Image: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:${{ github.sha }}" >> ../artifacts/run_summary.txt
        echo "MLflow Tracking URI: $MLFLOW_TRACKING_URI" >> ../artifacts/run_summary.txt
        
        # List artifacts
        echo "Generated artifacts:" >> ../artifacts/run_summary.txt
        ls -la ../artifacts/ >> ../artifacts/run_summary.txt
        
    - name: Upload Artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts-${{ github.sha }}
        path: artifacts/
        retention-days: 30
        
    - name: Commit and Push Artifacts (if on main branch)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      shell: bash -l {0}
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Create artifacts branch if it doesn't exist
        git fetch origin
        if git show-ref --verify --quiet refs/remotes/origin/artifacts; then
          git checkout artifacts
          git pull origin artifacts
        else
          git checkout --orphan artifacts
          git rm -rf .
        fi
        
        # Copy artifacts
        cp -r artifacts/* . 2>/dev/null || :
        
        # Add timestamp directory
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        mkdir -p "runs/$TIMESTAMP"
        cp -r artifacts/* "runs/$TIMESTAMP/" 2>/dev/null || :
        
        # Commit and push
        git add .
        git commit -m "Add MLflow artifacts from run ${{ github.sha }}" || echo "No changes to commit"
        git push origin artifacts
        
    - name: Update Docker Hub Link
      shell: bash -l {0}
      run: |
        # Update the docker-hub-link.txt with the new image
        echo "https://hub.docker.com/repository/docker/$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME" > MLProject/docker-hub-link.txt
        echo "Latest image: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:latest" >> MLProject/docker-hub-link.txt
        echo "SHA image: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:${{ github.sha }}" >> MLProject/docker-hub-link.txt
        
    - name: Display Run Summary
      shell: bash -l {0}
      run: |
        echo "ðŸŽ‰ MLflow CI/CD Pipeline Completed Successfully!"
        echo "=============================================="
        echo "âœ… Model training completed"
        echo "âœ… Docker image built and pushed to Docker Hub"
        echo "âœ… Artifacts saved to GitHub repository"
        echo ""
        echo "ðŸ“Š Run Details:"
        echo "Docker Image: $DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME:latest"
        echo "Commit SHA: ${{ github.sha }}"
        echo "Workflow URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "ðŸ”— Resources:"
        echo "- Docker Hub: https://hub.docker.com/repository/docker/$DOCKER_HUB_USERNAME/$DOCKER_IMAGE_NAME"
        echo "- Artifacts: Available in GitHub Actions artifacts and 'artifacts' branch"